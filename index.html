<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rizzerv - Restaurant Flow</title>
  <!-- Papa Parse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <!-- Inter Font -->
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
  />
  <style>
    /* Global resets and variables */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Inter", sans-serif;
    }

    :root {
      --color-bg: #0D1517;       /* Dark background */
      --color-text: #ffffff;     /* White text */
      --color-btn: #B1759F;      /* Add button color */
      --color-added: #2ecc71;    /* Button color when "Added" */
      --header-height: 60px;     /* Approx top row height */
    }

    body {
      background: var(--color-bg);
      color: var(--color-text);
      overflow-x: hidden; /* prevent horizontal scrolling */
    }

    /***********************************************
     * HEADER + SEARCH (Fixed)
    ***********************************************/
    .header {
      position: fixed;
      top: 0;
      width: 100%;
      display: flex;
      flex-direction: column; /* stack brand row + search row */
      background: var(--color-bg);
      z-index: 1000;
      transition: transform 0.3s ease; /* for hiding on scroll */
    }
    .header.hidden {
      transform: translateY(-100%);
    }

    /* Top row: brand & icons */
    .header-top {
      display: flex;
      align-items: center;
      height: var(--header-height);
      padding: 1rem 1.5rem; 
    }
    .header-top h1 {
      font-weight: 700;
      font-size: 24px;
      color: var(--color-text);
      margin: 0;
    }
    .header-icons {
      margin-left: auto;
      display: flex;
      gap: 1.5rem;
      align-items: center;
    }
    .header-icon {
      width: 24px;
      height: 24px;
      cursor: pointer;
    }

    /* Search bar row inside header */
    .search-container {
      display: none;  /* hidden initially */
      padding: 8px 1rem;
      border-top: 1px solid #444;
      border-bottom: 1px solid #444;
    }
    .search-container .search-wrapper {
      position: relative;
      width: 100%;
    }
    .search-container input {
      width: 100%;
      background: #252a2c;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 6px 8px;
      font-size: 16px;
    }
    /* "X" close button for search */
    .search-clear {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #aaa;
      font-size: 18px;
      cursor: pointer;
      user-select: none;
    }
    .search-clear:hover {
      color: #fff;
    }

    /***********************************************
     * RESTAURANT FLOW
    ***********************************************/
    .restaurant-flow {
      /* Enough margin-top to fit header (and search row if opened).
         The search row simply overlays if displayed. */
      margin-top: calc(var(--header-height) + 10px);
      padding-bottom: 100px; /* space for selection bar */
      transition: margin-top 0.3s ease;
    }

    .flow-item {
      position: relative;
      margin-bottom: 18px;
    }
    .image-container {
      position: relative;
      width: 100%;
      height: 300px;
      overflow: hidden;
    }
    .flow-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      cursor: pointer; /* double-click add */
    }

    /* Gradient Overlay (5 stops) */
    .gradient-overlay {
      position: absolute;
      top: 0; 
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      background: linear-gradient(
        to bottom,
        rgba(13,21,23,1) 0%,
        rgba(13,21,23,0.48) 31%,
        rgba(255,255,255,0) 51%,
        rgba(13,21,23,0.32) 84%,
        rgba(13,21,23,1) 100%
      );
    }
    .flow-name {
      position: absolute;
      top: 20px;
      left: 20px;
      font-weight: 700;
      font-size: 16px;
      color: var(--color-text);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      z-index: 2;
      cursor: pointer; /* opens details page */
    }
    .flow-mention {
      position: absolute;
      top: 42px;
      left: 20px;
      font-size: 14px;
      opacity: 0.8;
      color: var(--color-text);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      z-index: 2;
    }
    .flow-price {
      position: absolute;
      top: 20px;
      right: 20px;
      font-weight: 400;
      font-size: 16px;
      color: var(--color-text);
      background: none;
      z-index: 2;
    }

    /* "Add" button => corner radius 12px */
    .add-button {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: var(--color-btn);
      color: var(--color-text);
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 2;
    }
    .add-button.added {
      background: var(--color-added);
    }

    .flow-content {
      padding: 1rem 1.5rem;
    }
    .desc-short {
      font-size: 16px;
      margin-bottom: 0.5rem;
    }
    .desc-long {
      font-size: 14px;
      line-height: 1.4;
    }

    /***********************************************
     * SELECTION BAR
    ***********************************************/
    .selection-bar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--color-bg);
      padding: 12px 24px;
      border-radius: 50px;
      display: flex;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      z-index: 1001;
    }
    .thumbnail-container {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .selection-thumbnail {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      object-fit: cover;
      border: 2px solid var(--color-btn);
      cursor: pointer;
    }
    .next-button {
      display: none; 
      background: none;
      color: var(--color-text);
      border: 2px solid var(--color-text);
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    /***********************************************
     * LIMIT MESSAGE
    ***********************************************/
    .limit-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: 0.8rem 1.2rem;
      border-radius: 20px;
      font-size: 16px;
      display: none;
      z-index: 2000;
    }

    /***********************************************
     * FILTER CARD
    ***********************************************/
    .filter-card-overlay {
      display: none;            
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.7); 
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    .filter-card {
      background: var(--color-bg);
      color: var(--color-text);
      border: 2px solid #2c2c2c;
      border-radius: 10px;
      width: 320px;
      padding: 1.5rem;
      box-shadow: 0 8px 16px rgba(0,0,0,0.5);
    }
    .filter-card h2 {
      margin-bottom: 1rem;
      font-size: 18px;
    }
    .filter-card label {
      font-size: 14px;
      font-weight: 600;
      display: block;
      margin-top: 1rem;
      margin-bottom: 0.25rem;
    }
    .filter-card select {
      width: 100%;
      margin-bottom: 0.5rem;
      font-size: 14px;
      background: #252a2c;
      color: #fff;
      border: 1px solid #555;
      border-radius: 6px;
      padding: 4px;
    }
    .filter-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 1rem;
    }
    .filter-buttons button {
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-apply {
      background: var(--color-btn); 
      color: #fff;
    }
    .btn-close {
      background: none;
      color: #fff;
      border: 1px solid #fff;
    }

    /***********************************************
     * RESTAURANT DETAILS PAGE
    ***********************************************/
    .details-page {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;  
      background: var(--color-bg);
      z-index: 1200;  
      overflow-y: auto; /* scroll only the detail page */
    }
    .details-image-container {
      position: relative;
      width: 100%;
      height: 300px;
      overflow: hidden;
    }
    .details-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .details-gradient-overlay {
      position: absolute;
      top: 0; 
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      background: linear-gradient(
        to bottom,
        rgba(13,21,23,1) 0%,
        rgba(13,21,23,0.48) 31%,
        rgba(255,255,255,0) 51%,
        rgba(13,21,23,0.32) 84%,
        rgba(13,21,23,1) 100%
      );
    }
    .details-content {
      padding: 1rem 1.5rem 4rem; 
    }
    .details-name {
      position: absolute;
      top: 20px;
      left: 20px;
      font-weight: 700;
      font-size: 18px;
      color: var(--color-text);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      z-index: 2;
    }
    .details-mention {
      position: absolute;
      top: 42px;
      left: 20px;
      font-size: 14px;
      color: var(--color-text);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      z-index: 2;
      opacity: 0.8;
    }
    .details-back-button {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: none;
      color: #ffffff;
      border: none;
      padding: 0;
      font-weight: 500;
      font-size: 18px;
      cursor: pointer;
      z-index: 2;
    }
    .details-add-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--color-btn);
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 500;
      cursor: pointer;
      z-index: 2;
    }
    .details-add-button.added {
      background: var(--color-added);
    }
    .details-field {
      margin: 0.5rem 0;
      font-size: 15px;
      line-height: 1.4;
    }

    /***********************************************
     * RECAP PAGE (on Next)
    ***********************************************/
    .recap-page {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh; 
      background: var(--color-bg);
      z-index: 1300;  
      overflow-y: auto;
      padding-bottom: 4rem;
    }
    .recap-content {
      max-width: 600px;
      margin: 0 auto;
      padding: 1.5rem;
    }
    .recap-header {
      margin-bottom: 1.5rem;
      text-align: center;
    }
    .recap-header h2 {
      font-size: 22px;
      margin-bottom: 0.5rem;
    }
    .recap-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .recap-item {
      border: 1px solid #444;
      border-radius: 8px;
      padding: 0.8rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      background: #1a1a1a;
    }
    .recap-item img {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
      border: 2px solid var(--color-btn);
    }
    .recap-footer-buttons {
      position: fixed;
      bottom: 20px;
      width: 100%;
      display: flex;
      justify-content: space-around;
      left: 0;
    }
    .recap-button {
      background: none;
      border: 2px solid #fff;
      color: #fff;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      cursor: pointer;
      font-size: 16px;
    }
    .recap-button:hover {
      background: #444;
    }

  </style>
</head>
<body>
  <!-- HEADER (fixed) -->
  <div class="header" id="mainHeader">
    <!-- Top row: brand + icons -->
    <div class="header-top">
      <h1>Rizzerv</h1>
      <div class="header-icons">
        <img src="filter-list-svgrepo-com.svg" alt="Filter" class="header-icon" id="filterIcon" />
        <img src="magnifying-glass-backup-svgrepo-com.svg" alt="Search" class="header-icon" id="searchIcon" />
      </div>
    </div>
    <!-- Search bar row (hidden initially) -->
    <div class="search-container" id="searchContainer">
      <div class="search-wrapper">
        <input type="text" id="searchInput" placeholder="Search restaurants..." />
        <span class="search-clear" id="searchClearBtn">&times;</span>
      </div>
    </div>
  </div>

  <!-- "Limit reached!" Message -->
  <div class="limit-message" id="limitMessage">Limit reached!</div>

  <!-- Restaurant Feed -->
  <div class="restaurant-flow" id="restaurantFlow"></div>

  <!-- Selection Bar -->
  <div class="selection-bar">
    <div class="thumbnail-container" id="thumbnailContainer"></div>
    <button class="next-button" id="nextButton">Next</button>
  </div>

  <!-- FILTER CARD OVERLAY -->
  <div class="filter-card-overlay" id="filterOverlay">
    <div class="filter-card">
      <h2>Filter Options</h2>
      <label for="typeSelect">Type (Multi-Select)</label>
      <select id="typeSelect" size="5" multiple></select>

      <label for="sourceSelect">Mentioned in (Multi-Select)</label>
      <select id="sourceSelect" size="5" multiple></select>

      <div class="filter-buttons">
        <button class="btn-close" id="closeFilterBtn">Close</button>
        <button class="btn-apply" id="applyFilterBtn">Apply</button>
      </div>
    </div>
  </div>

  <!-- RESTAURANT DETAILS PAGE -->
  <div class="details-page" id="detailsPage">
    <div class="details-image-container" id="detailsImageContainer">
      <img src="" alt="Restaurant detail" class="details-image" id="detailsImage" />
      <div class="details-gradient-overlay"></div>
      <h2 class="details-name" id="detailsName"></h2>
      <div class="details-mention" id="detailsMention"></div>
    </div>
    <div class="details-content" id="detailsContent"></div>
    <!-- Floating Buttons (Back & Add) -->
    <button class="details-back-button" id="detailsBackButton">Back</button>
    <button class="details-add-button" id="detailsAddButton">Add</button>
  </div>

  <!-- RECAP PAGE -->
  <div class="recap-page" id="recapPage">
    <div class="recap-content">
      <div class="recap-header">
        <h2>Your Selection</h2>
        <p id="recapSubtitle">These are your chosen restaurants:</p>
      </div>
      <div class="recap-list" id="recapList"></div>
    </div>
    <div class="recap-footer-buttons">
      <button class="recap-button" id="recapBackBtn">Back</button>
      <button class="recap-button" id="recapDoneBtn">Done</button>
    </div>
  </div>

  <script>
    /********************************************************
     * GLOBAL DATA & CONSTANTS
    ********************************************************/
    const MAX_SELECTION = 4;
    let selectedRestaurants = []; // {id, name, image}
    let allRestaurants = [];
    let currentDisplayedIndices = [];

    // For searching
    let activeSearchTerm = "";

    // DOM references
    const header = document.getElementById("mainHeader");
    const headerTop = document.querySelector(".header-top");
    const searchContainer = document.getElementById("searchContainer");
    const searchInput = document.getElementById("searchInput");
    const searchClearBtn = document.getElementById("searchClearBtn");
    const restaurantFlow = document.getElementById("restaurantFlow");
    const thumbnailContainer = document.getElementById("thumbnailContainer");
    const nextButton = document.getElementById("nextButton");
    const limitMessage = document.getElementById("limitMessage");
    const filterIcon = document.getElementById("filterIcon");
    const filterOverlay = document.getElementById("filterOverlay");
    const closeFilterBtn = document.getElementById("closeFilterBtn");
    const applyFilterBtn = document.getElementById("applyFilterBtn");
    const typeSelect = document.getElementById("typeSelect");
    const sourceSelect = document.getElementById("sourceSelect");

    // Details Page
    const detailsPage = document.getElementById("detailsPage");
    const detailsImage = document.getElementById("detailsImage");
    const detailsName = document.getElementById("detailsName");
    const detailsMention = document.getElementById("detailsMention");
    const detailsContent = document.getElementById("detailsContent");
    const detailsBackButton = document.getElementById("detailsBackButton");
    const detailsAddButton = document.getElementById("detailsAddButton");

    // Recap Page
    const recapPage = document.getElementById("recapPage");
    const recapList = document.getElementById("recapList");
    const recapBackBtn = document.getElementById("recapBackBtn");
    const recapDoneBtn = document.getElementById("recapDoneBtn");

    // Icons
    const searchIcon = document.getElementById("searchIcon");

    /********************************************************
     * SHOW/HIDE "LIMIT REACHED!" MESSAGE
    ********************************************************/
    function showLimitMessage() {
      limitMessage.style.display = "block";
      setTimeout(() => {
        limitMessage.style.display = "none";
      }, 2000);
    }

    /********************************************************
     * FETCH CSV => POPULATE => RENDER
    ********************************************************/
    fetch("restaurants.csv")
      .then(resp => resp.text())
      .then(csv => {
        const parsed = Papa.parse(csv, { header: true });
        allRestaurants = parsed.data.filter(r => r.name);
        populateFilterOptions();
        renderRestaurants(allRestaurants);
      })
      .catch(err => console.error(err));

    function populateFilterOptions() {
      const shortSet = new Set();
      const sourceSet = new Set();

      allRestaurants.forEach(r => {
        if (r.description_short) shortSet.add(r.description_short);
        if (r.source1) sourceSet.add(r.source1);
      });

      typeSelect.innerHTML = "";
      sourceSelect.innerHTML = "";

      shortSet.forEach(val => {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val;
        typeSelect.appendChild(opt);
      });
      sourceSet.forEach(val => {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val;
        sourceSelect.appendChild(opt);
      });
    }

    /********************************************************
     * RENDER RESTAURANTS
    ********************************************************/
    function renderRestaurants(dataArr) {
      let html = "";
      currentDisplayedIndices = [];
      dataArr.forEach(row => {
        const originalIndex = allRestaurants.indexOf(row);
        if (originalIndex < 0) return;
        html += generateFlowItemHTML(row, originalIndex);
        currentDisplayedIndices.push(originalIndex);
      });
      restaurantFlow.innerHTML = html;
      attachAddButtons();
      attachNameClicks();
      attachPhotoDblclick();
    }

    function generateFlowItemHTML(restaurant, index) {
      const priceRange = "$60-$80"; // placeholder
      const shortDesc = restaurant.description_short || "";

      let longDesc = restaurant.description_long || "";
      const tooLong = longDesc.length > 100;
      longDesc = longDesc.slice(0, 100) + (tooLong ? "..." : "");

      let mentionLine = "";
      if (restaurant.source1) {
        mentionLine = `<div class="flow-mention">Mentioned in ${restaurant.source1}</div>`;
      }

      return `
        <div class="flow-item" data-id="${index}">
          <div class="image-container">
            <img src="${restaurant.photo_1}" class="flow-image" alt="${restaurant.name}" />
            <div class="gradient-overlay"></div>
            <h2 class="flow-name">${restaurant.name}</h2>
            ${mentionLine}
            <div class="flow-price">${priceRange}</div>
            <button class="add-button">Add</button>
          </div>
          <div class="flow-content">
            <p class="desc-short">${shortDesc}</p>
            <p class="desc-long">${longDesc}</p>
          </div>
        </div>
      `;
    }

    /********************************************************
     * ADD BUTTONS
    ********************************************************/
    function attachAddButtons() {
      document.querySelectorAll(".flow-item .add-button").forEach(btn => {
        btn.addEventListener("click", e => {
          const item = e.target.closest(".flow-item");
          const itemId = item.getAttribute("data-id");
          toggleRestaurantInSelection(itemId, btn);
        });
      });
    }

    function toggleRestaurantInSelection(itemId, buttonElem) {
      const rData = allRestaurants[itemId];
      if (!rData) return;

      const existing = selectedRestaurants.find(r => r.id === itemId);
      if (existing) {
        // Remove
        selectedRestaurants = selectedRestaurants.filter(r => r.id !== itemId);
        if (buttonElem) {
          buttonElem.classList.remove("added");
          buttonElem.textContent = "Add";
        }
      } else {
        // Add if under limit
        if (selectedRestaurants.length >= MAX_SELECTION) {
          showLimitMessage();
          return;
        }
        selectedRestaurants.push({ id: itemId, name: rData.name, image: rData.photo_1 });
        if (buttonElem) {
          buttonElem.classList.add("added");
          buttonElem.textContent = "Added";
        }
      }
      updateSelectionBar();
      attachThumbnailClicks();
    }

    /********************************************************
     * DOUBLE-CLICK PHOTO => ADD
    ********************************************************/
    function attachPhotoDblclick() {
      document.querySelectorAll(".flow-item .flow-image").forEach(img => {
        img.addEventListener("dblclick", e => {
          const item = e.target.closest(".flow-item");
          if (!item) return;
          const itemId = item.getAttribute("data-id");
          const addBtn = item.querySelector(".add-button");
          toggleRestaurantInSelection(itemId, addBtn);
        });
      });
    }

    /********************************************************
     * CLICK NAME => DETAILS
    ********************************************************/
    function attachNameClicks() {
      document.querySelectorAll(".flow-item .flow-name").forEach(nameEl => {
        nameEl.addEventListener("click", e => {
          const item = e.target.closest(".flow-item");
          if (!item) return;
          const itemId = item.getAttribute("data-id");
          openRestaurantDetails(itemId);
        });
      });
    }

    function openRestaurantDetails(itemId) {
      const rData = allRestaurants[itemId];
      if (!rData) return;

      // Lock feed scroll
      document.body.style.overflow = "hidden";

      detailsImage.src = rData.photo_1 || "";
      detailsName.textContent = rData.name || "";
      detailsMention.textContent = rData.source1 ? `Mentioned in ${rData.source1}` : "";

      let html = "";
      const descLong = rData.description_long || "";
      html += `<p class="details-field"><strong>Neighborhood:</strong> ${rData.neighborhood || "N/A"}</p>`;
      html += `<p class="details-field"><strong>Category:</strong> ${rData.category || "N/A"}</p>`;
      html += `<p class="details-field">${descLong}</p>`;
      detailsContent.innerHTML = html;

      // Update the Add button if it's selected or not
      const existing = selectedRestaurants.find(r => r.id === itemId);
      if (existing) {
        detailsAddButton.classList.add("added");
        detailsAddButton.textContent = "Added";
      } else {
        detailsAddButton.classList.remove("added");
        detailsAddButton.textContent = "Add";
      }
      detailsAddButton.setAttribute("data-id", itemId);

      detailsPage.style.display = "block";
    }

    detailsBackButton.addEventListener("click", () => {
      closeRestaurantDetails();
    });
    function closeRestaurantDetails() {
      detailsPage.style.display = "none";
      document.body.style.overflow = "";
    }

    detailsAddButton.addEventListener("click", e => {
      const itemId = e.target.getAttribute("data-id");
      if (!itemId) return;
      toggleRestaurantInSelection(itemId, detailsAddButton);
    });

    /********************************************************
     * SELECTION BAR
    ********************************************************/
    function updateSelectionBar() {
      thumbnailContainer.innerHTML = selectedRestaurants
        .map(r => `<img src="${r.image}" data-id="${r.id}" class="selection-thumbnail" alt="${r.name}">`)
        .join("");

      if (selectedRestaurants.length > 0) {
        nextButton.style.display = "inline-block";
      } else {
        nextButton.style.display = "none";
      }
    }
    function attachThumbnailClicks() {
      document.querySelectorAll(".selection-thumbnail").forEach(thumb => {
        thumb.addEventListener("click", () => {
          const id = thumb.getAttribute("data-id");
          openRestaurantDetails(id);
        });
      });
    }

    /********************************************************
     * NEXT BUTTON => RECAP PAGE
    ********************************************************/
    nextButton.addEventListener("click", () => {
      openRecapPage();
    });

    function openRecapPage() {
      let html = "";
      selectedRestaurants.forEach(sel => {
        html += `
          <div class="recap-item">
            <img src="${sel.image}" alt="${sel.name}" />
            <div>
              <div><strong>${sel.name}</strong></div>
            </div>
          </div>
        `;
      });
      recapList.innerHTML = html;

      recapPage.style.display = "block";
      document.body.style.overflow = "hidden";
    }

    recapBackBtn.addEventListener("click", () => {
      recapPage.style.display = "none";
      document.body.style.overflow = "";
    });
    recapDoneBtn.addEventListener("click", () => {
      alert("You clicked Done! Implement your final logic here.");
      recapPage.style.display = "none";
      document.body.style.overflow = "";
    });

    /********************************************************
     * FILTER CARD
    ********************************************************/
    filterIcon.addEventListener("click", () => {
      filterOverlay.style.display = "flex";
    });
    closeFilterBtn.addEventListener("click", () => {
      filterOverlay.style.display = "none";
    });
    applyFilterBtn.addEventListener("click", () => {
      const chosenTypes = getSelectedOptions(typeSelect);
      const chosenSources = getSelectedOptions(sourceSelect);

      let filtered = allRestaurants.filter(r => {
        const sDesc = r.description_short || "";
        const sSource = r.source1 || "";
        const matchesType = chosenTypes.length === 0 || chosenTypes.includes(sDesc);
        const matchesSource = chosenSources.length === 0 || chosenSources.includes(sSource);
        return matchesType && matchesSource;
      });

      renderRestaurants(filtered);
      filterOverlay.style.display = "none";
    });
    function getSelectedOptions(selectEl) {
      const result = [];
      for (let opt of selectEl.options) {
        if (opt.selected && opt.value) {
          result.push(opt.value);
        }
      }
      return result;
    }

    /********************************************************
     * SEARCH BAR (always visible on icon click)
    ********************************************************/
    searchIcon.addEventListener("click", () => {
      // Force header to become visible so that on mobile,
      // even if scrolled down, user sees the header + search
      header.classList.remove("hidden");

      if (searchContainer.style.display === "none" || !searchContainer.style.display) {
        searchContainer.style.display = "block";
        searchInput.focus();
      } else {
        hideSearchBar(false); 
      }
    });

    // "X" => clear & revert to all
    searchClearBtn.addEventListener("click", () => {
      searchInput.value = "";
      activeSearchTerm = "";
      renderRestaurants(allRestaurants);
      hideSearchBar(false);
    });

    // Click outside => hide, keep results
    document.addEventListener("click", e => {
      if (
        searchContainer.style.display === "block" &&
        !searchContainer.contains(e.target) &&
        e.target !== searchIcon &&
        !headerTop.contains(e.target)
      ) {
        hideSearchBar(true);
      }
    });

    // On scroll => hide, keep results
    window.addEventListener("scroll", () => {
      if (searchContainer.style.display === "block") {
        hideSearchBar(true);
      }
    });

    // Press Enter => hide search, keep results
    searchInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        hideSearchBar(true);
      }
    });

    function hideSearchBar(keepResults) {
      if (searchContainer.style.display === "none") return;
      searchContainer.style.display = "none";
      if (!keepResults) {
        activeSearchTerm = "";
        renderRestaurants(allRestaurants);
      }
    }

    // Live-filter as user types
    searchInput.addEventListener("input", e => {
      const val = e.target.value.trim().toLowerCase();
      activeSearchTerm = val;
      if (!val) {
        renderRestaurants(allRestaurants);
        return;
      }
      const filtered = allRestaurants.filter(r => {
        return r.name && r.name.toLowerCase().includes(val);
      });
      renderRestaurants(filtered);
    });

    /********************************************************
     * HEADER HIDE ON SCROLL, REAPPEAR ON STOP/UP
    ********************************************************/
    let lastScrollTop = 0;
    let scrollingTimeout;

    window.addEventListener("scroll", () => {
      // If details or recap page is open, do not hide header
      if (detailsPage.style.display === "block" || recapPage.style.display === "block") return;

      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      if (scrollTop > lastScrollTop) {
        // Scrolling down => hide
        header.classList.add("hidden");
      } else {
        // Scrolling up => show
        header.classList.remove("hidden");
      }
      lastScrollTop = Math.max(scrollTop, 0);

      // If user stops scrolling for 150ms => show again
      if (scrollingTimeout) clearTimeout(scrollingTimeout);
      scrollingTimeout = setTimeout(() => {
        header.classList.remove("hidden");
      }, 150);
    });
  </script>
</body>
</html>
