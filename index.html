<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rizzerv - Restaurant Flow</title>
  <!-- Papa Parse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <!-- Inter Font -->
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
  />
  <style>
    /* Global resets and variables */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Inter", sans-serif;
    }

    :root {
      --color-bg: #0D1517;       /* Dark background */
      --color-text: #ffffff;     /* White text */
      --color-btn: #B1759F;      /* Add button color */
      --color-added: #2ecc71;    /* Button color when "Added" */
    }

    body {
      background: var(--color-bg);
      color: var(--color-text);
    }

    /* Header */
    .header {
      position: fixed;
      top: 0;
      width: 100%;
      padding: 1.5rem;
      display: flex;
      align-items: center;
      background: var(--color-bg);
      z-index: 1000;
    }
    .header h1 {
      font-weight: 700;
      font-size: 24px;
      color: var(--color-text);
      margin: 0;
    }

    .header-icons {
      margin-left: auto;  /* push icons to the right */
      display: flex;
      gap: 1.5rem;
      align-items: center;
    }
    .header-icon {
      width: 24px;
      height: 24px;
      object-fit: contain;
      cursor: pointer;
    }

    /* Restaurant Flow container */
    .restaurant-flow {
      margin-top: 80px;           /* account for fixed header */
      padding-bottom: 100px;      /* account for selection bar */
    }

    .flow-item {
      position: relative;
      margin-bottom: 18px;        
    }

    .image-container {
      position: relative;
      width: 100%;
      height: 300px; 
      overflow: hidden;
    }

    .flow-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    /* Gradient Overlay (5 stops) */
    .gradient-overlay {
      position: absolute;
      top: 0; 
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      background: linear-gradient(
        to bottom,
        rgba(13,21,23,1) 0%,
        rgba(13,21,23,0.48) 31%,
        rgba(255,255,255,0) 51%,
        rgba(13,21,23,0.32) 84%,
        rgba(13,21,23,1) 100%
      );
    }

    .flow-name {
      position: absolute;
      top: 20px;
      left: 20px;
      font-weight: 700;
      font-size: 16px;
      color: var(--color-text);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      z-index: 2;
    }

    .flow-mention {
      position: absolute;
      top: 42px;
      left: 20px;
      font-size: 14px;
      opacity: 0.8;
      color: var(--color-text);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      z-index: 2;
    }

    .flow-price {
      position: absolute;
      top: 20px;
      right: 20px;
      font-weight: 400;
      font-size: 16px;
      color: var(--color-text);
      background: none;
      z-index: 2;
    }

    .add-button {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: var(--color-btn);
      color: var(--color-text);
      border: none;
      padding: 12px 24px;
      border-radius: 30px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 2;
    }
    .add-button.added {
      background: var(--color-added);
    }

    /* Descriptions below */
    .flow-content {
      padding: 1rem 1.5rem;
    }
    .desc-short {
      font-size: 16px;
      font-weight: 400;
      margin-bottom: 0.5rem;
    }
    .desc-long {
      font-size: 14px;
      font-weight: 400;
      line-height: 1.4;
    }

    /* Selection Bar at bottom */
    .selection-bar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--color-bg);
      padding: 12px 24px;
      border-radius: 50px;
      display: flex;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      z-index: 1001;
    }

    .thumbnail-container {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .selection-thumbnail {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      object-fit: cover;
      border: 2px solid var(--color-btn);
      cursor: pointer;
    }
    .next-button {
      display: none; 
      background: none;
      color: var(--color-text);
      border: 2px solid var(--color-text);
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    /* Limit message bubble (>4 selections) */
    .limit-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: 0.8rem 1.2rem;
      border-radius: 20px;
      font-size: 16px;
      font-weight: 400;
      display: none;
      z-index: 2000;
    }

    /***********************************************
      FILTER CARD - Match the dark theme
    ***********************************************/
    .filter-card-overlay {
      display: none;            
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.7); /* semi-transparent backdrop */
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    .filter-card {
      background: var(--color-bg);
      color: var(--color-text);
      border: 2px solid #2c2c2c;
      border-radius: 10px;
      width: 320px;
      padding: 1.5rem;
      box-shadow: 0 8px 16px rgba(0,0,0,0.5);
    }
    .filter-card h2 {
      margin-bottom: 1rem;
      font-size: 18px;
    }
    .filter-card label {
      font-size: 14px;
      font-weight: 600;
      display: block;
      margin-top: 1rem;
      margin-bottom: 0.25rem;
    }
    .filter-card select {
      width: 100%;
      margin-bottom: 0.5rem;
      font-size: 14px;
      background: #252a2c;
      color: #fff;
      border: 1px solid #555;
      border-radius: 6px;
      padding: 4px;
    }
    .filter-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 1rem;
    }
    .filter-buttons button {
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-apply {
      background: var(--color-btn); /* #B1759F */
      color: #fff;
    }
    .btn-close {
      background: none;
      color: #fff;
      border: 1px solid #fff;
    }

    /***********************************************
      SEARCH BAR
    ***********************************************/
    .search-container {
      position: absolute;
      top: 60px; /* just below the header */
      right: 20px;
      background: var(--color-bg);
      border: 1px solid #444;
      border-radius: 6px;
      padding: 8px;
      display: none; /* hidden by default */
      z-index: 1500;
    }
    .search-container input {
      background: #252a2c;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 6px 8px;
      width: 200px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <h1>Rizzerv</h1>
    <div class="header-icons">
      <img src="filter-list-svgrepo-com.svg" alt="Filter" class="header-icon" id="filterIcon" />
      <!-- Add ID to the Search icon for easy reference -->
      <img src="magnifying-glass-backup-svgrepo-com.svg" alt="Search" class="header-icon" id="searchIcon" />
    </div>
  </div>

  <!-- Hidden Search Container -->
  <div class="search-container" id="searchContainer">
    <input type="text" id="searchInput" placeholder="Search restaurants..." />
  </div>

  <!-- "Limit reached!" Message -->
  <div class="limit-message" id="limitMessage">Limit reached!</div>

  <!-- Flow Container -->
  <div class="restaurant-flow" id="restaurantFlow"></div>

  <!-- Selection Bar -->
  <div class="selection-bar">
    <div class="thumbnail-container" id="thumbnailContainer"></div>
    <button class="next-button" id="nextButton">Next</button>
  </div>

  <!-- FILTER CARD OVERLAY -->
  <div class="filter-card-overlay" id="filterOverlay">
    <div class="filter-card">
      <h2>Filter Options</h2>
      <!-- Type => short descriptions -->
      <label for="typeSelect">Type (Multi-Select)</label>
      <select id="typeSelect" size="5" multiple></select>

      <!-- Mentioned in => source1 -->
      <label for="sourceSelect">Mentioned in (Multi-Select)</label>
      <select id="sourceSelect" size="5" multiple></select>

      <div class="filter-buttons">
        <button class="btn-close" id="closeFilterBtn">Close</button>
        <button class="btn-apply" id="applyFilterBtn">Apply</button>
      </div>
    </div>
  </div>

  <script>
    const MAX_SELECTION = 4;
    let selectedRestaurants = [];
    let allRestaurants = [];
    let currentDisplayedIndices = []; // which restaurant indices are displayed

    // DOM references
    const restaurantFlow = document.getElementById("restaurantFlow");
    const thumbnailContainer = document.getElementById("thumbnailContainer");
    const nextButton = document.getElementById("nextButton");
    const limitMessage = document.getElementById("limitMessage");
    const filterIcon = document.getElementById("filterIcon");
    const filterOverlay = document.getElementById("filterOverlay");
    const closeFilterBtn = document.getElementById("closeFilterBtn");
    const applyFilterBtn = document.getElementById("applyFilterBtn");
    const typeSelect = document.getElementById("typeSelect");
    const sourceSelect = document.getElementById("sourceSelect");

    // SEARCH DOM references
    const searchIcon = document.getElementById("searchIcon");
    const searchContainer = document.getElementById("searchContainer");
    const searchInput = document.getElementById("searchInput");

    /********************************************************
     * Show/hide limit message
     ********************************************************/
    function showLimitMessage() {
      limitMessage.style.display = "block";
      setTimeout(() => {
        limitMessage.style.display = "none";
      }, 2000);
    }

    /********************************************************
     * Render and update restaurants
     ********************************************************/
    function renderRestaurants(dataArr) {
      let html = "";
      currentDisplayedIndices = [];
      dataArr.forEach((row) => {
        const originalIndex = allRestaurants.indexOf(row);
        // skip if row is invalid
        if (!row.name || originalIndex < 0) return;

        html += generateFlowItemHTML(row, originalIndex);
        currentDisplayedIndices.push(originalIndex);
      });
      restaurantFlow.innerHTML = html;
      attachAddButtons();
    }

    function generateFlowItemHTML(restaurant, index) {
      const priceRange = "$60-$80"; // placeholder
      const shortDesc = restaurant.description_short || "";

      let longDesc = restaurant.description_long || "";
      const tooLong = longDesc.length > 100;
      longDesc = longDesc.slice(0, 100) + (tooLong ? "..." : "");

      let mentionLine = "";
      if (restaurant.source1) {
        mentionLine = `
          <div class="flow-mention">
            Mentioned in ${restaurant.source1}
          </div>
        `;
      }

      return `
        <div class="flow-item" data-id="${index}">
          <div class="image-container">
            <img src="${restaurant.photo_1}" class="flow-image" alt="${restaurant.name}" />
            <div class="gradient-overlay"></div>
            <h2 class="flow-name">${restaurant.name}</h2>
            ${mentionLine}
            <div class="flow-price">${priceRange}</div>
            <button class="add-button">Add</button>
          </div>
          <div class="flow-content">
            <p class="desc-short">${shortDesc}</p>
            <p class="desc-long">${longDesc}</p>
          </div>
        </div>
      `;
    }

    function attachAddButtons() {
      document.querySelectorAll(".add-button").forEach((button) => {
        button.addEventListener("click", (e) => {
          const item = e.target.closest(".flow-item");
          const itemId = item.getAttribute("data-id"); 
          const name = item.querySelector(".flow-name").textContent;
          const image = item.querySelector(".flow-image").src;

          // Check if already selected
          const existing = selectedRestaurants.find((r) => r.id === itemId);

          if (existing) {
            // Remove
            selectedRestaurants = selectedRestaurants.filter((r) => r.id !== itemId);
            button.classList.remove("added");
            button.textContent = "Add";
          } else {
            // Add if under limit
            if (selectedRestaurants.length >= MAX_SELECTION) {
              showLimitMessage();
              return;
            }
            selectedRestaurants.push({ id: itemId, name, image });
            button.classList.add("added");
            button.textContent = "Added";
          }
          updateSelectionBar();
          attachThumbnailClicks();
        });
      });
    }

    function attachThumbnailClicks() {
      document.querySelectorAll(".selection-thumbnail").forEach((thumb) => {
        thumb.addEventListener("click", () => {
          const id = parseInt(thumb.getAttribute("data-id"), 10);
          // If this ID isn't currently displayed => reset to ALL
          if (!currentDisplayedIndices.includes(id)) {
            renderRestaurants(allRestaurants);
            setTimeout(() => {
              scrollToFlowItem(id);
            }, 50);
          } else {
            scrollToFlowItem(id);
          }
        });
      });
    }

    function scrollToFlowItem(id) {
      const target = document.querySelector(`.flow-item[data-id="${id}"]`);
      if (target) {
        target.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    }

    function updateSelectionBar() {
      thumbnailContainer.innerHTML = selectedRestaurants
        .map(
          (r) => `<img src="${r.image}" data-id="${r.id}" 
                    class="selection-thumbnail" alt="${r.name}">`
        )
        .join("");

      if (selectedRestaurants.length > 0) {
        nextButton.style.display = "inline-block";
      } else {
        nextButton.style.display = "none";
      }
    }

    // Next button placeholder
    nextButton.addEventListener("click", () => {
      alert("Next button clicked! Implement your own logic here.");
    });

    /********************************************************
     * FILTER CARD => MULTI-SELECT: shortDesc and source1
    ********************************************************/
    filterIcon.addEventListener("click", () => {
      filterOverlay.style.display = "flex";
    });
    closeFilterBtn.addEventListener("click", () => {
      filterOverlay.style.display = "none";
    });
    applyFilterBtn.addEventListener("click", () => {
      const chosenTypes = getSelectedOptions(typeSelect);
      const chosenSources = getSelectedOptions(sourceSelect);

      let filtered = allRestaurants.filter((r) => {
        const sDesc = r.description_short || "";
        const sSource = r.source1 || "";

        const matchesType = chosenTypes.length === 0 || chosenTypes.includes(sDesc);
        const matchesSource = chosenSources.length === 0 || chosenSources.includes(sSource);

        return matchesType && matchesSource;
      });

      renderRestaurants(filtered);
      filterOverlay.style.display = "none";
    });

    function getSelectedOptions(selectEl) {
      const result = [];
      for (let opt of selectEl.options) {
        if (opt.selected && opt.value) {
          result.push(opt.value);
        }
      }
      return result;
    }

    // CSV fetch => store => populate filter => render
    fetch("restaurants.csv")
      .then((resp) => resp.text())
      .then((csv) => {
        const parsed = Papa.parse(csv, { header: true });
        allRestaurants = parsed.data;
        populateFilterOptions();
        renderRestaurants(allRestaurants);
      })
      .catch((err) => console.error(err));

    function populateFilterOptions() {
      const shortSet = new Set();
      const sourceSet = new Set();

      allRestaurants.forEach((r) => {
        if (r.description_short) shortSet.add(r.description_short);
        if (r.source1) sourceSet.add(r.source1);
      });

      typeSelect.innerHTML = "";
      sourceSelect.innerHTML = "";

      shortSet.forEach((val) => {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val;
        typeSelect.appendChild(opt);
      });
      sourceSet.forEach((val) => {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val;
        sourceSelect.appendChild(opt);
      });
    }

    /********************************************************
     * SEARCH BAR FUNCTIONALITIES
    ********************************************************/
    // 1) Toggle display of search bar on icon click
    searchIcon.addEventListener("click", (e) => {
      e.stopPropagation(); // avoid immediate click-outside
      if (searchContainer.style.display === "none" || !searchContainer.style.display) {
        // Show search bar
        searchContainer.style.display = "block";
        searchInput.focus();
      } else {
        // Hide search bar
        hideSearchBar();
      }
    });

    // 2) Hide the search bar when clicking outside it
    document.addEventListener("click", (e) => {
      if (searchContainer.style.display === "block") {
        // If click is outside the search container & icon, close it
        if (
          !searchContainer.contains(e.target) &&
          e.target !== searchIcon
        ) {
          hideSearchBar();
        }
      }
    });

    function hideSearchBar() {
      searchContainer.style.display = "none";
      searchInput.value = "";
      renderRestaurants(allRestaurants);
    }

    // 3) Live-filter the restaurants by name as user types
    searchInput.addEventListener("input", (e) => {
      const searchTerm = e.target.value.trim().toLowerCase();
      if (!searchTerm) {
        // If empty, show all
        renderRestaurants(allRestaurants);
        return;
      }

      // Filter by restaurant name (case-insensitive)
      const filtered = allRestaurants.filter((r) => {
        return (
          r.name &&
          r.name.toLowerCase().includes(searchTerm)
        );
      });

      renderRestaurants(filtered);
    });
  </script>
</body>
</html>
